<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocNest - 文件列表</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        /* QR Code Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 350px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content img {
            max-width: 100%;
            margin: 20px 0;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #333;
        }
        .download-btn {
            display: inline-block;
            background-color: #34a853;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .download-btn:hover {
            background-color: #2d9249;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #4285f4;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            margin: 0;
        }
        .nav {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        .file-list {
            width: 100%;
            border-collapse: collapse;
        }
        .file-list th, .file-list td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .file-list th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #4285f4;
        }
        .file-list tr:hover {
            background-color: #f8f9fa;
        }
        .file-list .extraction-code {
            font-family: monospace;
            font-size: 16px;
            letter-spacing: 2px;
            color: #4285f4;
            font-weight: bold;
        }
        .file-list .actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            text-decoration: none;
        }
        .btn:hover {
            background-color: #3367d6;
        }
        .empty-list {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        .empty-list i {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 15px;
        }
        footer {
            text-align: center;
            padding: 20px 0;
            color: #666;
            font-size: 14px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>DocNest</h1>
            <div class="nav">
                <a href="/">上传文档</a>
                <a href="/list">文件列表</a>
                <a href="/query">查询文档</a>
                <a href="/users">用户管理</a>
                <a href="/logout">退出登录</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <h2>文件列表</h2>
            <p>系统中所有文档的列表，包含文件名和提取码</p>
            
            {% if documents %}
                <table class="file-list">
                    <thead>
                        <tr>
                            <th>文件编号</th>
                            <th>文件名</th>
                            <th>提取码</th>
                            <th>上传日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documents %}
                        <tr>
                            <td>{{ doc.file_number }}</td>
                            <td>{{ doc.original_filename }}</td>
                            <td class="extraction-code">{{ doc.extraction_code }}</td>
                            <td>{{ doc.upload_date }}</td>
                            <td class="actions">
                                <a href="/view/{{ doc.id }}" class="btn" title="查看文档">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn" title="查看二维码" onclick="showQRCode({{ doc.id }})">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                                <a href="/qrcode/{{ doc.id }}" class="btn" title="下载二维码" download="document-{{ doc.id }}-qrcode.png">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button class="btn delete-btn" style="background-color: #dc3545;" title="删除文档" data-id="{{ doc.id }}" data-filename="{{ doc.original_filename }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-list">
                    <i class="fas fa-folder-open"></i>
                    <p>暂无文档</p>
                    <a href="/" class="btn">上传文档</a>
                </div>
            {% endif %}
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 DocNest - 文档管理系统</p>
        </div>
    </footer>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteModal()">&times;</span>
            <h3>确认删除</h3>
            <p>您确定要删除文档 <span id="deleteFileName" style="font-weight: bold;"></span> 吗？</p>
            <p style="color: #dc3545;">此操作不可撤销！</p>
            <div style="margin: 20px 0; display: flex; justify-content: center; gap: 15px;">
                <button onclick="closeDeleteModal()" style="padding: 10px 15px; border-radius: 4px; border: none; background-color: #6c757d; color: white; cursor: pointer;">
                    取消
                </button>
                <button id="confirmDeleteBtn" style="padding: 10px 15px; border-radius: 4px; border: none; background-color: #dc3545; color: white; cursor: pointer;">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>文档二维码</h3>
            <p>扫描二维码可直接访问文档</p>
            <img id="qrCodeImage" src="" alt="文档二维码">
            <div style="margin: 20px 0;">
                <a id="downloadQRCode" href="#" class="download-btn" download>
                    <i class="fas fa-download"></i> 下载二维码
                </a>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        var currentDocumentId = null;
        
        // 显示二维码弹窗
        function showQRCode(documentId) {
            var modal = document.getElementById('qrCodeModal');
            var qrCodeImage = document.getElementById('qrCodeImage');
            var downloadLink = document.getElementById('downloadQRCode');
            
            // 设置二维码图片源
            var qrCodeUrl = '/qrcode/' + documentId;
            qrCodeImage.src = qrCodeUrl;
            
            // 设置下载链接
            downloadLink.href = qrCodeUrl;
            downloadLink.setAttribute('download', 'document-' + documentId + '-qrcode.png');
            
            // 显示弹窗
            modal.style.display = 'block';
        }
        
        // 关闭二维码弹窗
        function closeModal() {
            var modal = document.getElementById('qrCodeModal');
            modal.style.display = 'none';
        }
        
        // 显示删除确认弹窗
        function showDeleteConfirm(documentId, fileName) {
            currentDocumentId = documentId;
            var modal = document.getElementById('deleteConfirmModal');
            var fileNameSpan = document.getElementById('deleteFileName');
            var confirmBtn = document.getElementById('confirmDeleteBtn');
            
            // 设置文件名
            fileNameSpan.textContent = fileName;
            
            // 设置确认按钮点击事件
            confirmBtn.onclick = function() {
                deleteDocument(currentDocumentId);
            };
            
            // 显示弹窗
            modal.style.display = 'block';
        }
        
        // 关闭删除确认弹窗
        function closeDeleteModal() {
            var modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'none';
        }
        
        // 删除文档
        function deleteDocument(documentId) {
            // 发送删除请求
            fetch('/delete/' + documentId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(function(response) {
                if (response.ok) {
                    // 删除成功，刷新页面
                    window.location.reload();
                } else {
                    // 删除失败，显示错误信息
                    alert('删除文档失败，请稍后重试');
                    closeDeleteModal();
                }
            })
            .catch(function(error) {
                console.error('删除文档出错:', error);
                alert('删除文档出错，请稍后重试');
                closeDeleteModal();
            });
        }
        
        // 点击弹窗外部关闭弹窗
        window.onclick = function(event) {
            var qrModal = document.getElementById('qrCodeModal');
            var deleteModal = document.getElementById('deleteConfirmModal');
            
            if (event.target == qrModal) {
                qrModal.style.display = 'none';
            }
            
            if (event.target == deleteModal) {
                deleteModal.style.display = 'none';
            }
        };
        
        // 为所有删除按钮添加点击事件
        document.addEventListener('DOMContentLoaded', function() {
            var deleteButtons = document.querySelectorAll('.delete-btn');
            for (var i = 0; i < deleteButtons.length; i++) {
                deleteButtons[i].addEventListener('click', function() {
                    var documentId = this.getAttribute('data-id');
                    var fileName = this.getAttribute('data-filename');
                    showDeleteConfirm(documentId, fileName);
                });
            }
        });
    </script>
</body>
</html>
